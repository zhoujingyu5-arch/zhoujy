<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœè£…åº—æ™ºèƒ½è´¢åŠ¡ç³»ç»Ÿ - Proç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0f0f1e;
            --secondary: #1a1a2e;
            --accent: #ff006e;
            --success: #06ffa5;
            --warning: #ffbe0b;
            --info: #3a86ff;
            --text: #eaeaea;
            --glass: rgba(255, 255, 255, 0.05);
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--primary);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            width: 150%;
            height: 150%;
            background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255, 0, 110, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(58, 134, 255, 0.15) 0%, transparent 50%);
            animation: bgMove 20s ease-in-out infinite;
        }

        @keyframes bgMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-5%, 5%) rotate(5deg); }
            66% { transform: translate(5%, -5%) rotate(-5deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--success), var(--info));
            animation: borderGlow 3s linear infinite;
        }

        @keyframes borderGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #fff, var(--success), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .stat-card:hover::before {
            opacity: 0.1;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #fff, var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: var(--glass);
            padding: 10px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            background: transparent;
            border: 1px solid transparent;
            color: #888;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: var(--text);
            background: rgba(255,255,255,0.05);
        }

        .tab-btn.active {
            background: var(--gradient-1);
            color: white;
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
            animation: slideIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--success);
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .feature-card {
            background: rgba(0,0,0,0.2);
            border: 2px dashed rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card:hover {
            border-color: var(--accent);
            background: rgba(255,0,110,0.05);
            transform: translateY(-3px);
        }

        .feature-card.active {
            border-color: var(--success);
            background: rgba(6,255,165,0.05);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .feature-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .feature-desc {
            font-size: 0.9rem;
            color: #888;
        }

        input[type="file"] {
            display: none;
        }

        .upload-area {
            border: 3px dashed rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
            cursor: pointer;
            background: rgba(0,0,0,0.2);
        }

        .upload-area:hover {
            border-color: var(--info);
            background: rgba(58,134,255,0.05);
        }

        .upload-area.dragover {
            border-color: var(--success);
            background: rgba(6,255,165,0.1);
            transform: scale(1.02);
        }

        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid var(--accent);
            box-shadow: 0 0 30px rgba(255,0,110,0.3);
        }

        #reader {
            width: 100%;
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 2px solid var(--success);
            border-radius: 20px;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(6,255,165,0.5);
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            top: 0;
            animation: scan 2s linear infinite;
            box-shadow: 0 0 20px var(--accent);
        }

        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-weight: 500;
            font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--info);
            box-shadow: 0 0 0 3px rgba(58,134,255,0.1);
        }

        .btn {
            padding: 14px 28px;
            background: var(--gradient-1);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--secondary);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-success {
            background: linear-gradient(135deg, #06ffa5 0%, #00d9f5 100%);
            color: #000;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff006e 0%, #ff4d6d 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffbe0b 0%, #fb5607 100%);
            color: #000;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
        }

        th {
            background: rgba(0,0,0,0.3);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--success);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        tr:hover {
            background: rgba(255,255,255,0.03);
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background: rgba(6,255,165,0.15);
            color: var(--success);
            border: 1px solid rgba(6,255,165,0.3);
        }

        .badge-warning {
            background: rgba(255,190,11,0.15);
            color: var(--warning);
            border: 1px solid rgba(255,190,11,0.3);
        }

        .badge-danger {
            background: rgba(255,0,110,0.15);
            color: var(--accent);
            border: 1px solid rgba(255,0,110,0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
            padding: 20px;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }

        .modal-large {
            max-width: 900px;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #888;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: var(--accent);
            color: white;
            transform: rotate(90deg);
        }

        .preview-image {
            max-width: 100%;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .ocr-result {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--info);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-3);
            width: 0%;
            transition: width 0.3s;
            border-radius: 4px;
        }

        .excel-preview {
            max-height: 400px;
            overflow: auto;
            margin: 20px 0;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .excel-preview table {
            margin: 0;
            font-size: 0.9rem;
        }

        .excel-preview th {
            background: rgba(58,134,255,0.2);
            position: sticky;
            top: 0;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 45px;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            font-size: 1.2rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--secondary);
            color: white;
            padding: 16px 28px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
            font-weight: 600;
            border-left: 4px solid var(--success);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: var(--accent);
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            position: relative;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--success);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .camera-preview {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        #cameraVideo {
            width: 100%;
            display: block;
        }

        #cameraCanvas {
            display: none;
        }

        .camera-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .shutter-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--accent);
            border: 4px solid white;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .shutter-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255,0,110,0.5);
        }

        .shutter-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .feature-grid { grid-template-columns: 1fr; }
            .modal-content { padding: 20px; }
        }

        .tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .tag.success {
            background: rgba(6,255,165,0.1);
            border-color: rgba(6,255,165,0.3);
            color: var(--success);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .data-item {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 12px;
            border-left: 3px solid var(--info);
        }

        .data-label {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
        }
    </style>
<base target="_blank">
</head>
<body>
    <div class="bg-animation"></div>
    
    <header>
        <h1>ğŸ‘” æœè£…åº—æ™ºèƒ½è´¢åŠ¡ç³»ç»Ÿ Pro</h1>
        <p class="subtitle">æ‰«ç  Â· Excelå¯¼å…¥ Â· æ‹ç…§è¯†åˆ« Â· æ™ºèƒ½è®°è´¦</p>
    </header>

    <div class="container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-label">ä»Šæ—¥æ”¶å…¥</div>
                <div class="stat-value" id="todayIncome">Â¥0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-label">æœ¬æœˆæ”¶å…¥</div>
                <div class="stat-value" id="monthIncome">Â¥0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“¦</div>
                <div class="stat-label">åº“å­˜æ€»é‡</div>
                <div class="stat-value" id="totalStock">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ·ï¸</div>
                <div class="stat-label">å•†å“ç§ç±»</div>
                <div class="stat-value" id="productTypes">0</div>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('scan')">
                <span>ğŸ“·</span> æ™ºèƒ½æ”¶é“¶
            </button>
            <button class="tab-btn" onclick="switchTab('import')">
                <span>ğŸ“¥</span> æ‰¹é‡å¯¼å…¥
            </button>
            <button class="tab-btn" onclick="switchTab('inventory')">
                <span>ğŸ“¦</span> åº“å­˜ç®¡ç†
            </button>
            <button class="tab-btn" onclick="switchTab('records')">
                <span>ğŸ“Š</span> é”€å”®è®°å½•
            </button>
            <button class="tab-btn" onclick="switchTab('stats')">
                <span>ğŸ“ˆ</span> æ•°æ®åˆ†æ
            </button>
        </div>

        <!-- æ™ºèƒ½æ”¶é“¶ -->
        <div id="scan" class="tab-content active">
            <div class="card">
                <div class="card-title">é€‰æ‹©æ”¶é“¶æ–¹å¼</div>
                <div class="feature-grid">
                    <div class="feature-card" onclick="startScanMode('camera')">
                        <span class="feature-icon">ğŸ“·</span>
                        <div class="feature-title">æ‘„åƒå¤´æ‰«ç </div>
                        <div class="feature-desc">æ‰«æå•†å“äºŒç»´ç å¿«é€Ÿæ”¶é“¶</div>
                    </div>
                    <div class="feature-card" onclick="startScanMode('photo')">
                        <span class="feature-icon">ğŸ“¸</span>
                        <div class="feature-title">æ‹ç…§è¯†åˆ«</div>
                        <div class="feature-desc">æ‹æ‘„è¡£æœæ ‡ç­¾è‡ªåŠ¨è¯†åˆ«</div>
                    </div>
                    <div class="feature-card" onclick="startScanMode('manual')">
                        <span class="feature-icon">âŒ¨ï¸</span>
                        <div class="feature-title">æ‰‹åŠ¨è¾“å…¥</div>
                        <div class="feature-desc">æ‰‹åŠ¨è¾“å…¥å•†å“ç¼–ç </div>
                    </div>
                </div>

                <!-- æ‘„åƒå¤´æ‰«ç åŒºåŸŸ -->
                <div id="cameraScanArea" style="display: none;">
                    <div class="scanner-container">
                        <div id="reader"></div>
                        <div class="scan-overlay">
                            <div class="scan-line"></div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="stopScanMode()">åœæ­¢æ‰«æ</button>
                    </div>
                </div>

                <!-- æ‹ç…§è¯†åˆ«åŒºåŸŸ -->
                <div id="photoScanArea" style="display: none;">
                    <div class="camera-preview">
                        <video id="cameraVideo" autoplay playsinline></video>
                        <canvas id="cameraCanvas"></canvas>
                    </div>
                    <div class="camera-controls">
                        <button class="btn btn-secondary" onclick="stopCamera()">å–æ¶ˆ</button>
                        <button class="shutter-btn" onclick="takePhoto()"></button>
                        <button class="btn" onclick="switchCamera()">ğŸ”„ åˆ‡æ¢</button>
                    </div>
                    <div id="photoResult" style="display: none; margin-top: 20px;">
                        <img id="capturedImage" class="preview-image">
                        <div class="ocr-result" id="ocrText"></div>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="confirmOCR()">âœ… ç¡®è®¤è¯†åˆ«ç»“æœ</button>
                            <button class="btn btn-secondary" onclick="retakePhoto()">ğŸ”„ é‡æ–°æ‹æ‘„</button>
                        </div>
                    </div>
                </div>

                <!-- æ‰‹åŠ¨è¾“å…¥åŒºåŸŸ -->
                <div id="manualScanArea" style="display: none;">
                    <div class="form-group">
                        <label>è¾“å…¥å•†å“ç¼–ç </label>
                        <input type="text" id="manualCode" placeholder="æ‰«ææˆ–è¾“å…¥å•†å“æ¡å½¢ç ..." onkeypress="handleManualInput(event)">
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="searchManualCode()">ğŸ” æŸ¥è¯¢å•†å“</button>
                        <button class="btn btn-secondary" onclick="stopScanMode()">å–æ¶ˆ</button>
                    </div>
                </div>

                <!-- æ‰«æç»“æœ -->
                <div id="scanResult" style="display: none; margin-top: 30px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 25px; border-radius: 16px; border-left: 4px solid var(--success);">
                        <h3 style="margin-bottom: 20px; color: var(--success);">å•†å“ä¿¡æ¯ç¡®è®¤</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">å•†å“åç§°</div>
                                <div class="data-value" id="resultName">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">å•ä»·</div>
                                <div class="data-value" style="color: var(--accent);">Â¥<span id="resultPrice">-</span></div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">å½“å‰åº“å­˜</div>
                                <div class="data-value" id="resultStock">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">åˆ†ç±»</div>
                                <div class="data-value" id="resultCategory">-</div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label>é”€å”®æ•°é‡</label>
                            <input type="number" id="saleQuantity" value="1" min="1" style="max-width: 200px;">
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="confirmSale()">ğŸ’° ç¡®è®¤æ”¶æ¬¾</button>
                            <button class="btn btn-secondary" onclick="cancelScan()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‰¹é‡å¯¼å…¥ -->
        <div id="import" class="tab-content">
            <div class="card">
                <div class="card-title">ğŸ“¥ æ‰¹é‡å¯¼å…¥å•†å“</div>
                
                <div class="feature-grid">
                    <div class="feature-card" onclick="showExcelUpload()">
                        <span class="feature-icon">ğŸ“Š</span>
                        <div class="feature-title">Excelå¯¼å…¥</div>
                        <div class="feature-desc">ä¸Šä¼ Excelè¡¨æ ¼æ‰¹é‡æ·»åŠ å•†å“</div>
                    </div>
                    <div class="feature-card" onclick="showPhotoImport()">
                        <span class="feature-icon">ğŸ“¸</span>
                        <div class="feature-title">æ‹ç…§å…¥åº“</div>
                        <div class="feature-desc">æ‹æ‘„è¿›è´§å•æˆ–æ ‡ç­¾è‡ªåŠ¨è¯†åˆ«</div>
                    </div>
                </div>

                <!-- Excelä¸Šä¼ åŒºåŸŸ -->
                <div id="excelUploadArea" style="display: none;">
                    <div class="upload-area" id="dropZone" onclick="document.getElementById('excelFile').click()">
                        <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“</div>
                        <h3 style="margin-bottom: 10px;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Excelæ–‡ä»¶</h3>
                        <p style="color: #888; font-size: 0.9rem;">æ”¯æŒ .xlsx, .xls, .csv æ ¼å¼</p>
                        <p style="color: #666; font-size: 0.8rem; margin-top: 10px;">
                            è¡¨æ ¼éœ€åŒ…å«ï¼šç¼–ç ã€åç§°ã€åˆ†ç±»ã€è¿›ä»·ã€å”®ä»·ã€åº“å­˜
                        </p>
                    </div>
                    <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleExcelSelect(event)">
                    
                    <div class="excel-preview" id="excelPreview" style="display: none;">
                        <table>
                            <thead id="excelHead"></thead>
                            <tbody id="excelBody"></tbody>
                        </table>
                    </div>

                    <div class="action-buttons" id="excelActions" style="display: none;">
                        <button class="btn btn-success" onclick="confirmExcelImport()">âœ… ç¡®è®¤å¯¼å…¥</button>
                        <button class="btn btn-secondary" onclick="cancelExcelImport()">å–æ¶ˆ</button>
                    </div>
                </div>

                <!-- æ‹ç…§å…¥åº“åŒºåŸŸ -->
                <div id="photoImportArea" style="display: none;">
                    <div class="camera-preview">
                        <video id="importCameraVideo" autoplay playsinline></video>
                    </div>
                    <div class="camera-controls">
                        <button class="btn btn-secondary" onclick="stopImportCamera()">å–æ¶ˆ</button>
                        <button class="shutter-btn" onclick="takeImportPhoto()"></button>
                    </div>
                </div>
            </div>

            <!-- å¯¼å…¥æ¨¡æ¿ä¸‹è½½ -->
            <div class="card">
                <div class="card-title">ğŸ“‹ å¯¼å…¥æ¨¡æ¿</div>
                <p style="color: #888; margin-bottom: 15px;">ä¸‹è½½æ ‡å‡†æ¨¡æ¿ï¼ŒæŒ‰æ ¼å¼å¡«å†™åä¸Šä¼ </p>
                <button class="btn btn-secondary" onclick="downloadTemplate()">
                    ğŸ“¥ ä¸‹è½½Excelæ¨¡æ¿
                </button>
            </div>
        </div>

        <!-- åº“å­˜ç®¡ç† -->
        <div id="inventory" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div class="card-title" style="margin: 0;">ğŸ“¦ åº“å­˜ç®¡ç†</div>
                    <div class="action-buttons" style="margin: 0;">
                        <button class="btn" onclick="openAddModal()">â• å•ä»¶å…¥åº“</button>
                        <button class="btn btn-secondary" onclick="exportInventory()">ğŸ“¤ å¯¼å‡ºExcel</button>
                    </div>
                </div>

                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="searchInventory" placeholder="æœç´¢å•†å“åç§°ã€ç¼–ç æˆ–åˆ†ç±»..." oninput="renderInventory()">
                </div>

                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>å•†å“ç¼–ç </th>
                                <th>å•†å“åç§°</th>
                                <th>åˆ†ç±»</th>
                                <th>è¿›ä»·</th>
                                <th>å”®ä»·</th>
                                <th>åº“å­˜</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable"></tbody>
                    </table>
                </div>
                
                <div id="emptyInventory" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">ğŸ“¦</div>
                    <p>æš‚æ— åº“å­˜æ•°æ®</p>
                    <button class="btn" style="margin-top: 15px;" onclick="switchTab('import')">å»å¯¼å…¥å•†å“</button>
                </div>
            </div>
        </div>

        <!-- é”€å”®è®°å½• -->
        <div id="records" class="tab-content">
            <div class="card">
                <div class="card-title">ğŸ“Š é”€å”®è®°å½•</div>
                
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="searchRecords" placeholder="æœç´¢å•†å“åç§°..." oninput="renderRecords()">
                </div>

                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>å•†å“åç§°</th>
                                <th>å•ä»·</th>
                                <th>æ•°é‡</th>
                                <th>æ€»ä»·</th>
                                <th>åˆ©æ¶¦</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTable"></tbody>
                    </table>
                </div>

                <div id="emptyRecords" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p>æš‚æ— é”€å”®è®°å½•</p>
                </div>
            </div>
        </div>

        <!-- æ•°æ®åˆ†æ -->
        <div id="stats" class="tab-content">
            <div class="card">
                <div class="card-title">ğŸ“ˆ é”€å”®è¶‹åŠ¿ï¼ˆè¿‘7å¤©ï¼‰</div>
                <div class="chart-container" id="salesChart">
                    <!-- åŠ¨æ€ç”Ÿæˆå›¾è¡¨ -->
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ¥§ åˆ†ç±»é”€å”®å æ¯”</div>
                <div id="categoryStats" class="data-grid">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ† çƒ­é”€å•†å“TOP5</div>
                <div id="topProducts">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å•ä»¶å…¥åº“æ¨¡æ€æ¡† -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeAddModal()">Ã—</button>
            <div class="card-title">â• æ–°å¢å•†å“å…¥åº“</div>
            
            <div class="form-group">
                <label>å•†å“ç¼–ç </label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newCode" placeholder="æ‰«ææˆ–è¾“å…¥æ¡å½¢ç " style="flex: 1;">
                    <button class="btn btn-secondary" onclick="generateCode()">ç”Ÿæˆ</button>
                </div>
            </div>

            <div class="form-group">
                <label>å•†å“åç§°</label>
                <input type="text" id="newName" placeholder="ä¾‹å¦‚ï¼šå¤å­£çº¯æ£‰Tæ¤-ç™½è‰²-Mç ">
            </div>

            <div class="form-group">
                <label>åˆ†ç±»</label>
                <select id="newCategory">
                    <option value="ä¸Šè¡£">ğŸ‘• ä¸Šè¡£</option>
                    <option value="è£¤å­">ğŸ‘– è£¤å­</option>
                    <option value="è£™å­">ğŸ‘— è£™å­</option>
                    <option value="å¤–å¥—">ğŸ§¥ å¤–å¥—</option>
                    <option value="é…é¥°">ğŸ‘œ é…é¥°</option>
                    <option value="é‹å­">ğŸ‘Ÿ é‹å­</option>
                    <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                </select>
            </div>

            <div class="data-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="form-group">
                    <label>è¿›ä»·ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="newCost" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label>å”®ä»·ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="newPrice" placeholder="0.00" step="0.01">
                </div>
            </div>

            <div class="form-group">
                <label>åˆå§‹åº“å­˜</label>
                <input type="number" id="newStock" placeholder="0" min="0" value="1">
            </div>

            <div id="qrPreview" style="display: none; text-align: center; margin: 20px 0; padding: 20px; background: white; border-radius: 12px;">
                <div id="qrcode"></div>
                <p style="color: #333; margin-top: 10px; font-size: 0.9rem;">å•†å“äºŒç»´ç </p>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveProduct()">ğŸ’¾ ä¿å­˜å…¥åº“</button>
                <button class="btn btn-secondary" onclick="closeAddModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- OCRè¯†åˆ«ç»“æœæ¨¡æ€æ¡† -->
    <div id="ocrModal" class="modal">
        <div class="modal-content modal-large">
            <button class="close-btn" onclick="closeOCRModal()">Ã—</button>
            <div class="card-title">ğŸ” è¯†åˆ«ç»“æœç¡®è®¤</div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <img id="ocrImage" class="preview-image" style="margin: 0;">
                </div>
                <div>
                    <div class="ocr-result">
                        <h4 style="margin-bottom: 15px; color: var(--info);">è¯†åˆ«åˆ°çš„æ–‡å­—ï¼š</h4>
                        <div id="ocrTextFull" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--success);">æå–çš„å•†å“ä¿¡æ¯ï¼š</h4>
                        <div id="extractedInfo"></div>
                    </div>
                </div>
            </div>

            <div class="action-buttons" style="margin-top: 30px;">
                <button class="btn btn-success" onclick="confirmOCRImport()">âœ… ç¡®è®¤å¯¼å…¥</button>
                <button class="btn btn-secondary" onclick="closeOCRModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å°ç¥¨æ¨¡æ€æ¡† -->
    <div id="receiptModal" class="modal">
        <div class="modal-content" style="max-width: 320px; background: white; color: #333;">
            <button class="close-btn" onclick="closeReceipt()" style="color: #333;">Ã—</button>
            <div id="receiptContent" style="font-family: 'Courier New', monospace; text-align: center; padding: 20px;">
                <!-- å°ç¥¨å†…å®¹ -->
            </div>
            <button class="btn" style="width: 100%; margin-top: 20px;" onclick="printReceipt()">ğŸ–¨ï¸ æ‰“å°å°ç¥¨</button>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>

    <script>
        // æ•°æ®å­˜å‚¨
        let inventory = JSON.parse(localStorage.getItem('clothing_inventory_v2')) || [];
        let records = JSON.parse(localStorage.getItem('clothing_records_v2')) || [];
        let html5QrCode = null;
        let currentStream = null;
        let currentFacingMode = 'environment';
        let currentScanProduct = null;
        let excelData = [];
        let ocrResult = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateStats();
            renderInventory();
            renderRecords();
            initDragDrop();
        });

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.tab-btn').classList.add('active');

            if (tabName === 'stats') renderStats();
            if (tabName === 'inventory') renderInventory();
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const today = new Date().toDateString();
            const todaySales = records.filter(r => new Date(r.time).toDateString() === today);
            const todayIncome = todaySales.reduce((sum, r) => sum + r.total, 0);
            
            const currentMonth = new Date().getMonth();
            const monthSales = records.filter(r => new Date(r.time).getMonth() === currentMonth);
            const monthIncome = monthSales.reduce((sum, r) => sum + r.total, 0);
            
            const totalStock = inventory.reduce((sum, item) => sum + item.stock, 0);
            
            document.getElementById('todayIncome').textContent = `Â¥${todayIncome.toFixed(2)}`;
            document.getElementById('monthIncome').textContent = `Â¥${monthIncome.toFixed(2)}`;
            document.getElementById('totalStock').textContent = totalStock;
            document.getElementById('productTypes').textContent = inventory.length;
        }

        // ==================== æ‰«ç æ”¶é“¶åŠŸèƒ½ ====================
        
        function startScanMode(mode) {
            // é‡ç½®æ‰€æœ‰åŒºåŸŸ
            document.getElementById('cameraScanArea').style.display = 'none';
            document.getElementById('photoScanArea').style.display = 'none';
            document.getElementById('manualScanArea').style.display = 'none';
            document.getElementById('scanResult').style.display = 'none';
            
            // åœæ­¢ä¹‹å‰çš„æ‘„åƒå¤´
            stopCamera();
            if (html5QrCode) {
                html5QrCode.stop().catch(() => {});
            }

            if (mode === 'camera') {
                document.getElementById('cameraScanArea').style.display = 'block';
                startQRScanner();
            } else if (mode === 'photo') {
                document.getElementById('photoScanArea').style.display = 'block';
                startPhotoCamera();
            } else if (mode === 'manual') {
                document.getElementById('manualScanArea').style.display = 'block';
                document.getElementById('manualCode').focus();
            }
        }

        function stopScanMode() {
            document.getElementById('cameraScanArea').style.display = 'none';
            document.getElementById('photoScanArea').style.display = 'none';
            document.getElementById('manualScanArea').style.display = 'none';
            document.getElementById('scanResult').style.display = 'none';
            stopCamera();
            if (html5QrCode) {
                html5QrCode.stop().catch(() => {});
            }
        }

        // äºŒç»´ç æ‰«æ
        function startQRScanner() {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    handleCode(decodedText);
                    stopScanMode();
                },
                () => {}
            ).catch(err => {
                showToast('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™', 'error');
            });
        }

        // æ‹ç…§è¯†åˆ«åŠŸèƒ½
        async function startPhotoCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: currentFacingMode } 
                });
                currentStream = stream;
                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
            } catch (err) {
                showToast('æ— æ³•å¯åŠ¨æ‘„åƒå¤´', 'error');
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            stopCamera();
            startPhotoCamera();
        }

        async function takePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg');
            document.getElementById('capturedImage').src = imageData;
            document.getElementById('photoResult').style.display = 'block';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('ocrText').innerHTML = '<div class="loading"></div> æ­£åœ¨è¯†åˆ«æ–‡å­—...';
            
            try {
                const result = await Tesseract.recognize(
                    canvas,
                    'chi_sim+eng',
                    { logger: m => console.log(m) }
                );
                
                ocrResult = result.data.text;
                document.getElementById('ocrText').innerHTML = `
                    <strong>è¯†åˆ«ç»“æœï¼š</strong><br>
                    <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; font-family: monospace;">
                        ${ocrResult.replace(/\n/g, '<br>')}
                    </div>
                `;
                
                // å°è¯•æå–å•†å“ä¿¡æ¯
                extractProductInfo(ocrResult);
            } catch (err) {
                document.getElementById('ocrText').innerHTML = 'è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•';
            }
        }

        function extractProductInfo(text) {
            // ç®€å•çš„ä¿¡æ¯æå–é€»è¾‘
            const lines = text.split('\n').filter(l => l.trim());
            const info = {
                name: lines[0] || '',
                price: text.match(/[ï¿¥Â¥]\s*(\d+\.?\d*)/)?.[1] || '',
                code: text.match(/[A-Z0-9]{6,}/)?.[0] || ''
            };
            
            document.getElementById('ocrText').innerHTML += `
                <div style="margin-top: 15px; padding: 15px; background: rgba(6,255,165,0.1); border-radius: 8px; border-left: 3px solid var(--success);">
                    <strong>æå–ä¿¡æ¯ï¼š</strong><br>
                    åç§°ï¼š${info.name}<br>
                    ä»·æ ¼ï¼š${info.price ? 'Â¥'+info.price : 'æœªè¯†åˆ«'}<br>
                    ç¼–ç ï¼š${info.code || 'æœªè¯†åˆ«'}
                </div>
            `;
        }

        function retakePhoto() {
            document.getElementById('photoResult').style.display = 'none';
        }

        function confirmOCR() {
            if (!ocrResult) return;
            // è¿™é‡Œå¯ä»¥æ·»åŠ ç¡®è®¤åçš„å¤„ç†é€»è¾‘
            showToast('è¯†åˆ«å®Œæˆï¼Œè¯·åœ¨å…¥åº“é¡µé¢ç¡®è®¤');
            stopScanMode();
        }

        // æ‰‹åŠ¨è¾“å…¥
        function handleManualInput(e) {
            if (e.key === 'Enter') searchManualCode();
        }

        function searchManualCode() {
            const code = document.getElementById('manualCode').value.trim();
            if (code) handleCode(code);
        }

        function handleCode(code) {
            const product = inventory.find(item => item.code === code);
            
            if (!product) {
                showToast('æœªæ‰¾åˆ°è¯¥å•†å“ï¼Œè¯·å…ˆå…¥åº“', 'error');
                if (confirm('æ˜¯å¦ç«‹å³æ·»åŠ è¯¥å•†å“ï¼Ÿ')) {
                    openAddModal();
                    document.getElementById('newCode').value = code;
                }
                return;
            }

            if (product.stock <= 0) {
                showToast('è¯¥å•†å“åº“å­˜ä¸è¶³', 'error');
                return;
            }

            currentScanProduct = product;
            document.getElementById('resultName').textContent = product.name;
            document.getElementById('resultPrice').textContent = product.price;
            document.getElementById('resultStock').textContent = product.stock;
            document.getElementById('resultCategory').textContent = product.category;
            document.getElementById('saleQuantity').value = 1;
            document.getElementById('saleQuantity').max = product.stock;
            document.getElementById('scanResult').style.display = 'block';
        }

        function cancelScan() {
            document.getElementById('scanResult').style.display = 'none';
            document.getElementById('manualCode').value = '';
            currentScanProduct = null;
        }

        function confirmSale() {
            if (!currentScanProduct) return;
            
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            if (quantity > currentScanProduct.stock) {
                showToast('é”€å”®æ•°é‡è¶…è¿‡åº“å­˜', 'error');
                return;
            }

            const total = currentScanProduct.price * quantity;
            const profit = (currentScanProduct.price - currentScanProduct.cost) * quantity;
            
            currentScanProduct.stock -= quantity;
            saveData();
            
            const record = {
                id: Date.now(),
                time: new Date().toISOString(),
                productCode: currentScanProduct.code,
                productName: currentScanProduct.name,
                price: currentScanProduct.price,
                cost: currentScanProduct.cost,
                quantity: quantity,
                total: total,
                profit: profit
            };
            records.unshift(record);
            localStorage.setItem('clothing_records_v2', JSON.stringify(records));
            
            showReceipt(record);
            cancelScan();
            updateStats();
            renderInventory();
            showToast(`æ”¶æ¬¾æˆåŠŸ Â¥${total.toFixed(2)}`);
        }

        // ==================== Excelå¯¼å…¥åŠŸèƒ½ ====================

        function showExcelUpload() {
            document.getElementById('excelUploadArea').style.display = 'block';
            document.getElementById('photoImportArea').style.display = 'none';
        }

        function showPhotoImport() {
            document.getElementById('excelUploadArea').style.display = 'none';
            document.getElementById('photoImportArea').style.display = 'block';
            startImportCamera();
        }

        function initDragDrop() {
            const dropZone = document.getElementById('dropZone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
            });

            dropZone.addEventListener('drop', handleDrop, false);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) handleExcelFile(files[0]);
        }

        function handleExcelSelect(e) {
            if (e.target.files.length) handleExcelFile(e.target.files[0]);
        }

        function handleExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showToast('Excelæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®', 'error');
                        return;
                    }

                    excelData = jsonData;
                    previewExcelData(jsonData);
                } catch (err) {
                    showToast('è§£æExcelå¤±è´¥', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function previewExcelData(data) {
            const headers = data[0];
            const rows = data.slice(1, 6); // é¢„è§ˆå‰5è¡Œ
            
            const thead = document.getElementById('excelHead');
            const tbody = document.getElementById('excelBody');
            
            thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            tbody.innerHTML = rows.map(row => 
                '<tr>' + row.map(cell => `<td>${cell || ''}</td>`).join('') + '</tr>'
            ).join('');
            
            document.getElementById('excelPreview').style.display = 'block';
            document.getElementById('excelActions').style.display = 'flex';
        }

        function confirmExcelImport() {
            if (excelData.length < 2) return;
            
            const headers = excelData[0].map(h => h.toString().trim());
            const rows = excelData.slice(1);
            
            let successCount = 0;
            let skipCount = 0;
            
            rows.forEach(row => {
                if (row.length < 2) return;
                
                const item = {};
                headers.forEach((h, i) => {
                    item[h] = row[i];
                });
                
                const code = item['ç¼–ç '] || item['code'] || item['æ¡å½¢ç '] || '';
                const name = item['åç§°'] || item['name'] || item['å•†å“åç§°'] || '';
                const category = item['åˆ†ç±»'] || item['category'] || 'å…¶ä»–';
                const cost = parseFloat(item['è¿›ä»·'] || item['cost'] || 0);
                const price = parseFloat(item['å”®ä»·'] || item['price'] || 0);
                const stock = parseInt(item['åº“å­˜'] || item['stock'] || 0);
                
                if (!code || !name) {
                    skipCount++;
                    return;
                }
                
                if (inventory.find(i => i.code === code)) {
                    skipCount++;
                    return;
                }
                
                inventory.push({
                    code,
                    name,
                    category,
                    cost,
                    price,
                    stock
                });
                successCount++;
            });
            
            saveData();
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('excelActions').style.display = 'none';
            document.getElementById('excelFile').value = '';
            excelData = [];
            
            updateStats();
            renderInventory();
            showToast(`æˆåŠŸå¯¼å…¥ ${successCount} ä»¶å•†å“ï¼Œè·³è¿‡ ${skipCount} ä»¶`);
        }

        function cancelExcelImport() {
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('excelActions').style.display = 'none';
            document.getElementById('excelFile').value = '';
            excelData = [];
        }

        function downloadTemplate() {
            const template = [
                ['ç¼–ç ', 'åç§°', 'åˆ†ç±»', 'è¿›ä»·', 'å”®ä»·', 'åº“å­˜'],
                ['EX001', 'ç¤ºä¾‹Tæ¤-ç™½è‰²-M', 'ä¸Šè¡£', 35.00, 89.00, 100],
                ['EX002', 'ç¤ºä¾‹ç‰›ä»”è£¤-è“è‰²-28', 'è£¤å­', 65.00, 159.00, 50]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'å•†å“æ¨¡æ¿');
            XLSX.writeFile(wb, 'å•†å“å¯¼å…¥æ¨¡æ¿.xlsx');
        }

        // æ‹ç…§å…¥åº“æ‘„åƒå¤´
        async function startImportCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const video = document.getElementById('importCameraVideo');
                video.srcObject = stream;
            } catch (err) {
                showToast('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥', 'error');
            }
        }

        function stopImportCamera() {
            const video = document.getElementById('importCameraVideo');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('photoImportArea').style.display = 'none';
        }

        async function takeImportPhoto() {
            const video = document.getElementById('importCameraVideo');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            stopImportCamera();
            
            // æ˜¾ç¤ºè¯†åˆ«ä¸­
            showToast('æ­£åœ¨è¯†åˆ«è¿›è´§å•...');
            
            try {
                const result = await Tesseract.recognize(canvas, 'chi_sim+eng');
                document.getElementById('ocrImage').src = canvas.toDataURL();
                document.getElementById('ocrTextFull').textContent = result.data.text;
                
                // è§£æè¿›è´§å•
                const items = parseInvoiceText(result.data.text);
                displayExtractedItems(items);
                
                document.getElementById('ocrModal').classList.add('active');
            } catch (err) {
                showToast('è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        function parseInvoiceText(text) {
            // ç®€å•çš„è¿›è´§å•è§£æé€»è¾‘
            const lines = text.split('\n').filter(l => l.trim());
            const items = [];
            
            // å°è¯•åŒ¹é…å¸¸è§çš„å•†å“ä¿¡æ¯æ¨¡å¼
            const patterns = [
                /(\d+)\s+([^\d]+)\s+(\d+\.?\d*)\s+(\d+)\s+(\d+\.?\d*)/,  // åºå· åç§° å•ä»· æ•°é‡ æ€»ä»·
                /([A-Z0-9]+)\s+([^\n]+?)\s+(\d+\.?\d*)\s*å…ƒ/,  // ç¼–ç  åç§° ä»·æ ¼
            ];
            
            lines.forEach(line => {
                patterns.forEach(pattern => {
                    const match = line.match(pattern);
                    if (match) {
                        items.push({
                            code: match[1] || 'AUTO' + Date.now(),
                            name: match[2]?.trim() || 'æœªå‘½åå•†å“',
                            price: parseFloat(match[3]) || 0,
                            quantity: parseInt(match[4]) || 1
                        });
                    }
                });
            });
            
            return items.length ? items : [{ name: 'æœªè¯†åˆ«åˆ°å•†å“', text: text }];
        }

        function displayExtractedItems(items) {
            const container = document.getElementById('extractedInfo');
            container.innerHTML = items.map((item, i) => `
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--info);">
                    <div style="font-weight: 600; margin-bottom: 5px;">${item.name}</div>
                    ${item.price ? `<div style="font-size: 0.9rem; color: #888;">ä»·æ ¼ï¼šÂ¥${item.price} Ã— ${item.quantity || 1}</div>` : ''}
                </div>
            `).join('');
        }

        function closeOCRModal() {
            document.getElementById('ocrModal').classList.remove('active');
        }

        function confirmOCRImport() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ ç¡®è®¤å¯¼å…¥é€»è¾‘
            closeOCRModal();
            showToast('è¿›è´§å•å¤„ç†å®Œæˆ');
        }

        // ==================== åº“å­˜ç®¡ç† ====================

        function renderInventory() {
            const search = document.getElementById('searchInventory').value.toLowerCase();
            const filtered = inventory.filter(item => 
                item.name.toLowerCase().includes(search) || 
                item.code.toLowerCase().includes(search) ||
                item.category.includes(search)
            );
            
            const tbody = document.getElementById('inventoryTable');
            const emptyDiv = document.getElementById('emptyInventory');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '';
                emptyDiv.style.display = 'block';
                return;
            }
            
            emptyDiv.style.display = 'none';
            tbody.innerHTML = filtered.map(item => `
                <tr>
                    <td><span class="tag">${item.code}</span></td>
                    <td><strong>${item.name}</strong></td>
                    <td>${item.category}</td>
                    <td>Â¥${item.cost}</td>
                    <td style="color: var(--accent); font-weight: 700;">Â¥${item.price}</td>
                    <td>${item.stock}</td>
                    <td><span class="badge ${item.stock > 10 ? 'badge-success' : item.stock > 0 ? 'badge-warning' : 'badge-danger'}">
                        ${item.stock > 10 ? 'å……è¶³' : item.stock > 0 ? 'ç´§å¼ ' : 'ç¼ºè´§'}
                    </span></td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="editStock('${item.code}')">è¡¥è´§</button>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;" onclick="deleteProduct('${item.code}')">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            generateCode();
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        function generateCode() {
            const code = 'C' + Date.now().toString(36).toUpperCase().slice(-8);
            document.getElementById('newCode').value = code;
            
            // ç”ŸæˆäºŒç»´ç é¢„è§ˆ
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: code,
                width: 128,
                height: 128,
                colorDark: '#000',
                colorLight: '#fff'
            });
            document.getElementById('qrPreview').style.display = 'block';
        }

        function saveProduct() {
            const code = document.getElementById('newCode').value.trim();
            const name = document.getElementById('newName').value.trim();
            const category = document.getElementById('newCategory').value;
            const cost = parseFloat(document.getElementById('newCost').value) || 0;
            const price = parseFloat(document.getElementById('newPrice').value) || 0;
            const stock = parseInt(document.getElementById('newStock').value) || 0;

            if (!code || !name) {
                showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }

            if (inventory.find(item => item.code === code)) {
                showToast('è¯¥ç¼–ç å·²å­˜åœ¨', 'error');
                return;
            }

            inventory.push({ code, name, category, cost, price, stock, createTime: new Date().toISOString() });
            saveData();
            closeAddModal();
            renderInventory();
            updateStats();
            showToast('å•†å“å…¥åº“æˆåŠŸ');
        }

        function editStock(code) {
            const item = inventory.find(i => i.code === code);
            const add = prompt(`å½“å‰åº“å­˜ï¼š${item.stock}\nè¯·è¾“å…¥è¡¥è´§æ•°é‡ï¼š`, '10');
            if (add && !isNaN(add) && add > 0) {
                item.stock += parseInt(add);
                saveData();
                renderInventory();
                updateStats();
                showToast(`å·²è¡¥è´§ ${add} ä»¶`);
            }
        }

        function deleteProduct(code) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥å•†å“ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤')) return;
            inventory = inventory.filter(i => i.code !== code);
            saveData();
            renderInventory();
            updateStats();
            showToast('å•†å“å·²åˆ é™¤');
        }

        function exportInventory() {
            const data = inventory.map(item => ({
                'ç¼–ç ': item.code,
                'åç§°': item.name,
                'åˆ†ç±»': item.category,
                'è¿›ä»·': item.cost,
                'å”®ä»·': item.price,
                'åº“å­˜': item.stock,
                'å…¥åº“æ—¶é—´': new Date(item.createTime).toLocaleString('zh-CN')
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'åº“å­˜æ¸…å•');
            XLSX.writeFile(wb, `åº“å­˜æ¸…å•_${new Date().toLocaleDateString()}.xlsx`);
            showToast('å¯¼å‡ºæˆåŠŸ');
        }

        // ==================== é”€å”®è®°å½• ====================

        function renderRecords() {
            const search = document.getElementById('searchRecords').value.toLowerCase();
            const filtered = records.filter(r => r.productName.toLowerCase().includes(search));
            
            const tbody = document.getElementById('recordsTable');
            const emptyDiv = document.getElementById('emptyRecords');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '';
                emptyDiv.style.display = 'block';
                return;
            }
            
            emptyDiv.style.display = 'none';
            tbody.innerHTML = filtered.slice(0, 100).map(r => `
                <tr>
                    <td>${new Date(r.time).toLocaleString('zh-CN')}</td>
                    <td>${r.productName}</td>
                    <td>Â¥${r.price}</td>
                    <td>${r.quantity}</td>
                    <td style="color: var(--accent); font-weight: 700;">Â¥${r.total.toFixed(2)}</td>
                    <td style="color: var(--success);">Â¥${r.profit.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.85rem;" onclick="showReceiptById(${r.id})">å°ç¥¨</button>
                    </td>
                </tr>
            `).join('');
        }

        // ==================== å°ç¥¨åŠŸèƒ½ ====================

        function showReceipt(record) {
            const content = `
                <div style="border-bottom: 2px dashed #ccc; padding-bottom: 15px; margin-bottom: 15px;">
                    <h2 style="margin: 0; font-size: 1.3rem;">ğŸ‘” æœè£…åº—é”€å”®å°ç¥¨</h2>
                    <p style="margin: 8px 0 0; font-size: 0.8rem; color: #666;">${new Date(record.time).toLocaleString('zh-CN')}</p>
                    <p style="margin: 4px 0 0; font-size: 0.75rem; color: #999;">å•å·ï¼š${record.id.toString().slice(-8)}</p>
                </div>
                <div style="text-align: left; margin: 15px 0; font-size: 0.9rem;">
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>å•†å“ï¼š</span>
                        <span style="flex: 1; text-align: right; margin-left: 10px;">${record.productName}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>å•ä»·ï¼š</span>
                        <span>Â¥${record.price}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                        <span>æ•°é‡ï¼š</span>
                        <span>${record.quantity}</span>
                    </div>
                    <div style="border-top: 1px dashed #ccc; margin: 12px 0; padding-top: 12px; display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1rem;">
                        <span>æ€»è®¡ï¼š</span>
                        <span>Â¥${record.total.toFixed(2)}</span>
                    </div>
                </div>
                <div style="border-top: 2px dashed #ccc; padding-top: 15px; margin-top: 15px; font-size: 0.75rem; color: #999;">
                    <p style="margin: 4px 0;">è°¢è°¢æƒ é¡¾ï¼Œæ¬¢è¿ä¸‹æ¬¡å…‰ä¸´ï¼</p>
                    <p style="margin: 4px 0;">é€€æ¢è´§è¯·å‡­å°ç¥¨7æ—¥å†…åŠç†</p>
                </div>
            `;
            document.getElementById('receiptContent').innerHTML = content;
            document.getElementById('receiptModal').classList.add('active');
        }

        function showReceiptById(id) {
            const record = records.find(r => r.id === id);
            if (record) showReceipt(record);
        }

        function closeReceipt() {
            document.getElementById('receiptModal').classList.remove('active');
        }

        function printReceipt() {
            window.print();
        }

        // ==================== æ•°æ®ç»Ÿè®¡ ====================

        function renderStats() {
            // è¿‘7å¤©é”€å”®å›¾è¡¨
            const days = [];
            const sales = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                days.push(dateStr);
                
                const dayTotal = records
                    .filter(r => new Date(r.time).toDateString() === d.toDateString())
                    .reduce((sum, r) => sum + r.total, 0);
                sales.push(dayTotal);
            }
            
            const maxSale = Math.max(...sales, 1);
            const chartContainer = document.getElementById('salesChart');
            chartContainer.innerHTML = `
                <div style="display: flex; align-items: flex-end; justify-content: space-around; height: 100%; padding: 20px; gap: 8px;">
                    ${days.map((day, i) => `
                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--success);">Â¥${sales[i].toFixed(0)}</div>
                            <div style="width: 100%; background: linear-gradient(to top, var(--accent), var(--info)); border-radius: 6px 6px 0 0; transition: all 0.3s; min-height: 5px; height: ${(sales[i] / maxSale * 200) || 5}px;"></div>
                            <div style="font-size: 0.75rem; color: #888;">${day}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            // åˆ†ç±»ç»Ÿè®¡
            const categories = {};
            records.forEach(r => {
                const item = inventory.find(i => i.code === r.productCode);
                const cat = item ? item.category : 'å…¶ä»–';
                categories[cat] = (categories[cat] || 0) + r.total;
            });
            
            const totalSales = Object.values(categories).reduce((a, b) => a + b, 0);
            const catContainer = document.getElementById('categoryStats');
            catContainer.innerHTML = Object.entries(categories).sort((a,b) => b[1] - a[1]).map(([cat, amount]) => `
                <div class="data-item" style="border-left-color: var(--accent);">
                    <div class="data-label">${cat}</div>
                    <div class="data-value">Â¥${amount.toFixed(2)}</div>
                    <div style="margin-top: 5px; font-size: 0.85rem; color: #666;">${((amount/totalSales)*100).toFixed(1)}%</div>
                </div>
            `).join('');

            // çƒ­é”€å•†å“TOP5
            const productSales = {};
            records.forEach(r => {
                productSales[r.productName] = (productSales[r.productName] || 0) + r.quantity;
            });
            
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            document.getElementById('topProducts').innerHTML = topProducts.map(([name, qty], i) => `
                <div style="display: flex; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 10px; border-left: 3px solid ${i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : i === 2 ? '#CD7F32' : 'var(--info)'};">
                    <div style="font-size: 1.5rem; margin-right: 15px; width: 30px; text-align: center;">${i < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i] : (i+1)}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${name}</div>
                        <div style="font-size: 0.85rem; color: #888;">é”€é‡ï¼š${qty} ä»¶</div>
                    </div>
                </div>
            `).join('') || '<div class="empty-state" style="padding: 40px;"><div class="empty-state-icon">ğŸ“Š</div><p>æš‚æ— é”€å”®æ•°æ®</p></div>';
        }

        // ==================== å·¥å…·å‡½æ•° ====================

        function saveData() {
            localStorage.setItem('clothing_inventory_v2', JSON.stringify(inventory));
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (type === 'error' ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>